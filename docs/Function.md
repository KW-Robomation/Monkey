# Function

## 1. 개요

본 문서는 로봇팔 시뮬레이터 프로젝트 **Plutto**의  
주요 기능(Function)들이 **어떤 목적을 가지고, 어떤 순서와 역할로 동작하는지**를 설명합니다.

본 문서는 **구현 코드의 세부 로직과 처리 흐름**을 설명하는 것을 목적으로 하며,  
각 함수의 인자, 반환값, 사용 방법에 대한 설명은  
개발 도구(VS Code)에서 제공하는 JavaScript 문서화 기능을 따릅니다.

---

## 2. 전체 실행 흐름

Plutto 시뮬레이터는 다음과 같은 단계로 동작합니다.

1. 시뮬레이터 팝업 및 캔버스 초기화
2. 로봇 기구학 파라미터 설정
3. SVG 또는 JSON 기반 모션 데이터 로딩
4. 로봇 관절 각도 업데이트
5. Forward Kinematics 계산
6. 로봇 팔 및 펜 상태 렌더링
7. 궤적(trail) 기록 및 시각화

본 문서는 위 흐름을 기준으로  
각 기능 블록의 역할을 단계별로 설명합니다.

---

## 3. 시뮬레이터 초기화 관련 기능

### 3.1. 시뮬레이터 시작 및 팝업 생성

로봇 시뮬레이터를 팝업 형태로 실행하며,  
p5.js 기반의 캔버스를 포함한 UI 환경을 초기화합니다.

- 시뮬레이터 팝업 생성
- p5 인스턴스 초기화
- 시뮬레이터 실행 진입점 역할

---

### 3.2. 캔버스 및 렌더링 환경 초기화

시뮬레이터 실행 시 한 번만 수행되며,  
다음 요소들을 초기화합니다.

- 캔버스 크기 및 스케일 설정
- 프레임 레이트 지정
- 로봇 이미지 리소스 로딩
- 궤적(trail) 레이어 생성

---

## 4. 로봇 기구학 설정 및 상태 관리

### 4.1. 로봇 기하 구조 계산

로봇 팔의 링크 길이와 기본 각도를  
이미지 좌표계를 기준으로 계산합니다.

계산된 기하 정보는  
Forward / Inverse Kinematics 연산의 기준으로 사용됩니다.

---

### 4.2. 베이스 위치 및 좌표계 설정

로봇의 기준점(Base Joint)을  
캔버스 좌표계 상의 특정 위치에 고정합니다.

이를 통해  
SVG 좌표계와 로봇 좌표계 간 변환의 기준을 일관되게 유지합니다.

---

### 4.3. 관절 각도 상태 관리

로봇의 현재 관절 각도는 전역 상태로 관리되며,  
다음 두 가지 방식으로 갱신됩니다.

- 사용자 입력에 의한 수동 조작
- 모션 데이터에 의한 자동 재생

각도 값은 항상 정규화 및 관절 제한 범위를 거쳐 적용됩니다.

---

## 5. 모션 데이터 재생 처리

### 5.1. JSON 기반 모션 재생

Plutto에서 생성된 모션 JSON 데이터를 순차적으로 해석하여  
로봇 관절 각도 변화량과 펜 상태를 적용합니다.

각 스텝은 다음 절차로 처리됩니다.

1. 관절 각도 증분 적용
2. 관절 제한 범위 클램프
3. 펜 상태 업데이트
4. 엔코더 값 동기화

---

### 5.2. 재생 모드 구분

모션 재생은 여러 가지 모드를 지원하며,  
각 모드는 재생 속도 및 시각화 방식이 다릅니다.

- 수동 모드
- 자동 재생 모드
- 고속 재생 모드
- 결과 미리보기 모드

---

## 6. 궤적(trail) 생성 및 관리

### 6.1. 궤적 레이어의 목적

펜이 종이에 접촉한 상태에서 이동한 경로를  
시각적으로 표현하기 위해  
별도의 궤적 레이어를 사용합니다.

궤적은 로봇 팔 렌더링과 분리되어 관리됩니다.

---

### 6.2. 실시간 궤적 기록

모션 재생 중 각 스텝의 결과 위치를 계산하여,  
펜이 Down 상태인 경우에만  
이전 위치와 현재 위치를 연결합니다.

---

### 6.3. 궤적 일괄 생성 (Bake)

전체 모션 데이터를 한 번에 실행하여  
최종 드로잉 결과만을 생성하는 기능입니다.

이 과정에서는  
중간 프레임 렌더링을 생략합니다.

---

## 7. Forward Kinematics 기반 렌더링

### 7.1. 관절 각도 기반 위치 계산

현재 관절 각도를 기반으로  
Forward Kinematics를 수행하여  
각 관절 및 펜의 화면 좌표를 계산합니다.

---

### 7.2. 로봇 팔 이미지 렌더링

계산된 관절 위치와 각도를 기준으로  
로봇 팔 이미지(베이스, 상부, 하부)를  
순차적으로 화면에 렌더링합니다.

---

## 8. 상태 시각화 및 디버그 정보

시뮬레이터 화면에는  
로봇의 현재 상태를 확인할 수 있는  
디버그 정보가 함께 표시됩니다.

- 관절 각도
- 링크 길이
- 펜 위치
- 재생 상태
- 관절 이동 범위

---

## 9. 문서 간 참조 관계

- SVG 입력 및 파싱 과정: [Parsing](Parsing.md)
- 통신 포맷 및 데이터 구조: [Plutto Path](Plutto_Path.md)
- 하드웨어 기준 및 관절 제약: [HW Specification](HW_Specification.md)
- 용어 정의: [Terminology](Terminology.md)

본 문서는 위 문서들에서 정의된 개념을 기반으로  
Plutto 시뮬레이터의 실제 동작 방식을 설명합니다.
